

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/myfavicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Shi_Kang">
  <meta name="keywords" content="">
  
    <meta name="description" content="Spring Security SpringSecurity 安全管理框架 ( 之后简称 security ) 是基于过滤器实现的权限验证功能，他可以验证用户的身份以及所拥有的权限来判断你是否具有访问目标资源的条件 安全管理框架除了 security 之外还有 shiro 也可以实现相同的功能，相比之下 security 就笨重一些，但是相对的带来的好处就是相比 shiro，security 对于">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security">
<meta property="og:url" content="http://example.com/2023/09/13/SpringSecurity%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Shi_Kang">
<meta property="og:description" content="Spring Security SpringSecurity 安全管理框架 ( 之后简称 security ) 是基于过滤器实现的权限验证功能，他可以验证用户的身份以及所拥有的权限来判断你是否具有访问目标资源的条件 安全管理框架除了 security 之外还有 shiro 也可以实现相同的功能，相比之下 security 就笨重一些，但是相对的带来的好处就是相比 shiro，security 对于">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2023/11/26/GyIdrAsehtBv1ug.png">
<meta property="article:published_time" content="2023-09-13T14:46:25.000Z">
<meta property="article:modified_time" content="2024-10-12T02:08:00.583Z">
<meta property="article:author" content="Shi_Kang">
<meta property="article:tag" content="Spring家族">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2023/11/26/GyIdrAsehtBv1ug.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Spring Security - Shi_Kang</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Shi·s Web Space</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Spring Security"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-09-13 22:46" pubdate>
          September 13, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          5.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          49 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Spring Security</h1>
            
            
              <div class="markdown-body">
                
                <h1>Spring Security</h1>
<p>SpringSecurity 安全管理框架 ( 之后简称 security ) 是基于过滤器实现的权限验证功能，他可以验证用户的身份以及所拥有的权限来判断你是否具有访问目标资源的条件</p>
<p>安全管理框架除了 security 之外还有 shiro 也可以实现相同的功能，相比之下 security 就笨重一些，但是相对的带来的好处就是相比 shiro，security 对于访问权限的把控细粒度比较好</p>
<p>笔记基于 Springboot 2.4.0 的 web 程序通过 Java 代码 + 注解的方式进行配置 ( 不使用 xml 配置文件 )</p>
<h2 id="快速开始">快速开始</h2>
<p>创建好 boot 程序之后，导入静态素材页面至 templates 目录下，配置好三个 level 的视图 ( 页面来自狂神说 ) 跳转就可以开始练习了</p>
<p><img src="/img/security-01.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>boot 项目添加 security 环境需要在项目创建时勾选 security 模块，或者手动在 pom 文件中添加场景启动器：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- security场景启动器，除此之外还引用了web、thymeleaf、test、lombok... --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当我们将依赖引入后，无需做任何的配置，security 就已经开始工作了，他默认会验证所有请求只有登录的情况下才可以访问，并且为我们提供了登录页面：</p>
<p><img src="/img/security-02.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>security 默认提供的登录用户名为 <code>user</code>，登录密码是随机分配的，通过查看程序启动日志就可以看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Using generated security password: f20e3e53-b7fc-4a3b-9d53-f6cc57b9c586</span><br></pre></td></tr></table></figure>
<p>输入用户名密码后我们就可以登录了，security 非常的智能，他会记录被拦截之前访问的页面，登录后 security 会重新访问该页面以方便操作，这就是 security 最简单的登录验证了</p>
<h2 id="访问权限设置-一">访问权限设置(一)</h2>
<blockquote>
<p>请求的授权验证和放行</p>
</blockquote>
<p>我们可以看到，security 的默认配置连 index 首页也访问不了，这不是我想要的，我们要调整一下页面的访问权限，这里需要创建 security 的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpringSecurity的配置类要求</span></span><br><span class="line"><span class="comment"> *   1.标注了<span class="doctag">@EnableWebSecurity</span>注解</span></span><br><span class="line"><span class="comment"> *   2.继承了WebSecurityConfigurerAdapter抽象类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>配置类创建好了，接下来需要复写其中的 <code>configure</code> 方法来自定义访问权限，这里需要注意的是重写的方法是重载方法，参数列表为：<code>HttpSecurity http</code> 不要重写错了，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求流程：访问控制器 GetMapping(&quot;/&quot;) 跳转到视图 &quot;index.html&quot;</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// authorizeRequests：这里要设置根据请求进行授权验证</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// antMatchers：如果方法访问的是这些请求地址</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>)</span><br><span class="line">                <span class="comment">// permitAll：不进行验证，直接放行可直接进行访问</span></span><br><span class="line">                .permitAll()</span><br><span class="line">                <span class="comment">// 剩下的所有请求</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">// 都要进行授权验证</span></span><br><span class="line">                .authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>所有关于请求验证方面的操作都需要在 <strong>http.authorizeRequests()</strong> 下进行</li>
</ul>
<p>对哪些请求操作可以通过 <code>antMatchers</code> 进行添加，例如对 / 或者对 index.html 请求进行操作，<code>anyRequest</code> 代表剩下的所有请求，而具体执行什么操作可以通过 <code>permitAll</code> 和 <code>authenticated</code> 进行设置</p>
<p>如上设置后，就可以在未登录的情况下访问 index 程序首页，而访问 level1 2 3 等就需要进行登录，直接访问会提示 403 Forbidden 没有权限访问</p>
<p><img src="/img/security-03.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<h2 id="登录表单设置">登录表单设置</h2>
<h3 id="简单登录授权">简单登录授权</h3>
<p>上面通过重写 <code>configure(HttpSecurity http)</code> 方法实现了请求的授权与放行，以及授权失败后的 403 页面，但是之前我们没有设置的时候他会自动跳转到登录页面，这个时候我们就需要添加一下表单的相关设置了</p>
<p>之前说过 <code>authorizeRequests</code> 是根据请求进行授权验证，验证部分结束后开始进行表单方面设置，需要使用 <code>formLogin</code> 来对表单进行操作，<strong>当进行两种不同操作的时候，中间需要用 <code>and()</code> 连接</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">            <span class="comment">// 添加表单方面的设置</span></span><br><span class="line">            .formLogin();  <span class="comment">// 这一句话就可以开启登录表单了</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加 <code>formLogin</code> 之后，访问 level 1 2 3 页面就会自动跳转到 security 为我们提供的登录页，输入用户名密码后所有页面就都可以访问了</p>
<h3 id="自定义登录设置">自定义登录设置</h3>
<blockquote>
<p>登录页面设置</p>
</blockquote>
<p>security 为我们提供了登录页面很方便，但是有点不太好看，我们在程序中要求每个页面都要贴合主题的，这个页面未免有些太突兀了，所以这里我们要自定义登录页面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">                <span class="comment">// 涉及到所有有关请求的路径都需要在这里配置过滤</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>, <span class="string">&quot;/toLogin&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;/views/login.html&quot;</span>, <span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                .permitAll().anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">            .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/toLogin&quot;</span>);  <span class="comment">// 自定义登录页为toLogin地址</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单配置 <code>loginPage</code> 之后，我们的自定义登录页就完成了，接下来我们修改修改一下表单的 name 以及提交地址</p>
<blockquote>
<p>修改表单提交地址以及表单项</p>
</blockquote>
<p>security 提供的登录页表单的 name 和提交的 action 地址都是预设好的，所以这里我们要先获取一下然后放到自己的登录页面中</p>
<p><img src="/img/security-04.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>当我们配置好要求后去进行登录，结果 <strong>请求的地址不存在404</strong>，这是因为我们在<strong>自定义登录页面的同时也影响到了表单提交地址</strong>，<em>表单的提交地址和自定义的登录地址相同</em>，也就是说我们通过 get 请求访问 toLogin 跳转到了登录页面，然后需要通过 post 请求访问 toLogin 进行登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">        .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>, <span class="string">&quot;/toLogin&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;/views/login.html&quot;</span>, <span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">        .permitAll().anyRequest().authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(<span class="string">&quot;/toLogin&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>); <span class="comment">// 表单的POST提交地址接口，无需自己实现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有些时候我们的登录名并不是 username 以及 password，可能是一些其他的值，而且表单的提交地址也不想和页面使用同一个地址，这里我们都可以通过自定义操作来完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">        .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>, <span class="string">&quot;/toLogin&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;/views/login.html&quot;</span>, <span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">        .permitAll().anyRequest().authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(<span class="string">&quot;/toLogin&quot;</span>)</span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">        .usernameParameter(<span class="string">&quot;name&quot;</span>)  <span class="comment">// 自定义username表单的name属性值</span></span><br><span class="line">        .passwordParameter(<span class="string">&quot;pwd&quot;</span>)  <span class="comment">// 自定义password表单中的name属性值</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>);  <span class="comment">// 自定义表单请求地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="登录成功后的视图跳转">登录成功后的视图跳转</h3>
<p>这里了解一下登录成功和失败的页面跳转处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>, <span class="string">&quot;/toLogin&quot;</span>,<span class="string">&quot;/views/login.html&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;/doLogin&quot;</span>, <span class="string">&quot;/toPage/success&quot;</span>)</span><br><span class="line">                .permitAll().anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">            .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/toLogin&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">                .usernameParameter(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">                .passwordParameter(<span class="string">&quot;pwd&quot;</span>)</span><br><span class="line">                <span class="comment">// 登录成功后默认跳转的页面</span></span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/toPage/success&quot;</span>)</span><br><span class="line">             <span class="comment">// 登录失败后跳转的页面</span></span><br><span class="line">                .failureUrl(<span class="string">&quot;/toPage/error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里需要注意的是 <code>defaultSuccessUrl</code> 设置的是默认成功的页面，但如果是通过访问其他页面被过滤后跳转到登录页的话，这项设置就不会起作用</li>
</ul>
<h2 id="用户登录设置">用户登录设置</h2>
<p>之前我们登录时都是通过日志提供的用户名密码进行登录，接下来我们就使用自己的用户进行登录</p>
<p>我们在实现请求验证以及表单操作的时候都是复写了父类的 <code>configure(HttpSecurity http)</code> 完成操作的，接下来的用户登录相关操作需要复写另外一个方法：<code>configure(AuthenticationManagerBuilder auth)</code></p>
<h3 id="内存模拟登录">内存模拟登录</h3>
<p>首先复写父类中的函数，然后配置内存模拟登陆，需要提一嘴的是高版本的 security 要求必须使用加密：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">PasswordEncoder</span> <span class="variable">noEncrypt</span> <span class="operator">=</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    auth.inMemoryAuthentication()  <span class="comment">// 在内存中模拟用户</span></span><br><span class="line">        .passwordEncoder(noEncrypt) <span class="comment">// 设置加密方式</span></span><br><span class="line">        .withUser(<span class="string">&quot;zhang&quot;</span>)    <span class="comment">// 添加用户</span></span><br><span class="line">        .password(<span class="string">&quot;hanzhe&quot;</span>)</span><br><span class="line">        .authorities(<span class="string">&quot;用户列表:查询&quot;</span>)</span><br><span class="line">        .and()  <span class="comment">// 通过and()连接无限添加用户</span></span><br><span class="line">        .withUser(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        .password(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        .roles(<span class="string">&quot;管理员&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>inMemoryAuthentication</code>：代表用户信息在内存中取</li>
<li><code>passwordEncoder</code>：<strong>高版本的 security 要求必须对登录密码进行加密</strong>，但是我们测试时不想使用加密，所以就通过 <code>NoOpPasswordEncoder</code> 获取了实例，这个实例并不会对密码进行加密，他作用就是占个位，从而实现配置了加密的同时不执行加密操作，加密具体后面会提</li>
<li><code>withUser</code>：添加用户，需要传入用户名进行登录，后面紧跟的几个方法就是当前用户的 <code>password</code> 密码，<code>roles</code> 角色和 <code>authorities</code> 权限等，通过 <code>and</code> 可以无限链接添加用户</li>
<li>注意事项：
<ul>
<li>每个用户应至少拥有一个角色或者权限，否则不允许登录</li>
<li>角色和权限的命名都不允许使用 “ROLE_” 开头</li>
</ul>
</li>
</ul>
<p>这样一来内存模拟登录就简单完成了，启动程序后最明显的就是日志中不会在提供 user 用户，我们可以通过自己添加的用户进行登录。</p>
<h3 id="连接数据库登录">连接数据库登录</h3>
<blockquote>
<p>前置准备：entity dao service</p>
</blockquote>
<p><i>这里简单偷个懒，在Service中写了假数据没有 dao没连数据库，不过道理是一样的</i></p>
<p>上面我们通过 <code>inMemoryAuthentication</code> 来模拟内存登录，接下来通过 <strong><code>UserDetailsService</code></strong> 来进行登录，准备好实体类以及 service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实体类</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserEntity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service层</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"> <span class="comment">// 用于存储用户列表</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;UserEntity&gt; userList = <span class="literal">null</span>;</span><br><span class="line"> <span class="comment">// 模拟的用户假数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initUserList</span><span class="params">()</span> &#123;</span><br><span class="line">        userList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">UserEntity</span>(<span class="string">&quot;zhang&quot;</span>, <span class="string">&quot;18D7044C8EAF484A1C498379BA770E1E&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">UserEntity</span>(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;21232F297A57A5A743894A0E4A801FC3&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">// 通过用户名查找用户的方法</span></span><br><span class="line">    <span class="keyword">public</span> UserEntity <span class="title function_">selectUserByUsername</span><span class="params">(String username)</span>&#123;</span><br><span class="line">        <span class="comment">// 每次获取信息之前都要重置一下用户列表</span></span><br><span class="line">        <span class="built_in">this</span>.initUserList();</span><br><span class="line">        List&lt;UserEntity&gt; collect = userList.stream()</span><br><span class="line">                .filter(item -&gt; item.getUsername().equals(username))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> collect.size() == <span class="number">1</span> ? collect.get(<span class="number">0</span>) : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置类代码</p>
</blockquote>
<p>之前配置在内存中登录时使用的是 <code>auth.inMemoryAuthentication()</code> 方法，这回配置数据库登录后使用的是 <code>auth.userDetailsService</code> 方法，这里需要传入 <code>UserDetailsService</code> 的实例，而<code>UserDetailsService</code> 实际上是一个接口，而且是支持函数式的接口，这里就使用 lambda 表达式进行操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">PasswordEncoder</span> <span class="variable">noEncrypt</span> <span class="operator">=</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    <span class="comment">// 函数接收的username就是登录表单提交的username</span></span><br><span class="line">    auth.userDetailsService((String username)-&gt;&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 这个集合是必须得有的，用于存储角色和权限的集合，其中角色由 &quot;ROLE_&quot; 开头，权限正常添</span></span><br><span class="line"><span class="comment">         * 加即可，正是因为这里需要通过 ROLE_ 开头来区分角色和权限，所以我们自己创建角色或权限</span></span><br><span class="line"><span class="comment">         * 的时候不可以使用 ROLE_ 开头，不然在这个地方会影响程序的运行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 通过username查询该用户的实体信息</span></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> userService.selectUserByUsername(username);</span><br><span class="line">        <span class="comment">// 通过用户查询他所拥有的权限以及角色，然后插入到集合中</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="string">&quot;admin&quot;</span>.equals(username) )    <span class="comment">// 角色要以ROLE_开头存储</span></span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_管理员&quot;</span>));</span><br><span class="line">        <span class="keyword">else</span> authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;用户列表:查询&quot;</span>));</span><br><span class="line">        <span class="comment">// 最后将用户名，密码，权限信息等封装为一个User对象，需要注意这个User是security包下的类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(username, userEntity.getPassword(), authorities);</span><br><span class="line">    &#125;).passwordEncoder(noEncrypt); <span class="comment">// 加密配置不能忘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来就配置完成了，只要自行连接数据库通过 service 调用 dao，这就是一个数据库的登录</p>
<h3 id="关于加密配置">关于加密配置</h3>
<p>无论是内存模拟登录 <code>inMemoryAuthentication</code> 还是数据库登录 <code>userDetailsService</code>，在用户信息配置完成之后都会调用 <code>passwordEncoder</code> 传入一个加密实例进行密码加密，之前图省事用了 <code>NoOpPasswordEncoder</code> 的实例，他的作用是不对密码进行加密操作，当我们在真实开发环境下的时候数据库是不建议存储明文密码的，所以在 security 中加密是必须配置的，这里就了解一下如何配置加密</p>
<h4 id="使用MD5加密">使用MD5加密</h4>
<blockquote>
<p>首先准备 MD5 的加密工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MD5Util</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toMD5</span><span class="params">(String source)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">md5</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] digest = md5.digest(source.getBytes());</span><br><span class="line">            target = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, digest).toString(<span class="number">16</span>).toUpperCase();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建Security的密码加密配置类</p>
</blockquote>
<p>点进 <code>passwordEncoder</code> 方法，我们可以看到他需要的是 <code>PasswordEncoder</code> 的实例，那就创建一个类来实现这个 <code>PasswordEncoder</code> 接口类来自定义加密：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Security的密码加密类，只需要实现encode和matches方法即可</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PwdEncoderConfig</span> <span class="keyword">implements</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line"> <span class="comment">// 用于密码加密的方法，rawPassword为我们在表单提交的明文密码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MD5Util.toMD5(rawPassword.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用于比较两个密码是否相同，rawPassword为表单密码，encodedPassword为数据库密码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MD5Util.toMD5(rawPassword.toString()).equals(encodedPassword);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>回到 Security 配置类配置类中传入加密对象即可</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 省略一大滩代码</span></span><br><span class="line">    auth.userDetailsService((String username)-&gt;&#123;......&#125;)</span><br><span class="line">        <span class="comment">// 这里传入了自定义的MD5加密算法</span></span><br><span class="line">        .passwordEncoder(<span class="keyword">new</span> <span class="title class_">PwdEncoderConfig</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 service 中测试的密码通过 md5 加密一下就可以验证效果了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userList.add(<span class="keyword">new</span> <span class="title class_">UserEntity</span>(<span class="string">&quot;zhang&quot;</span>, <span class="string">&quot;18D7044C8EAF484A1C498379BA770E1E&quot;</span>));  <span class="comment">// hanzhe</span></span><br><span class="line">userList.add(<span class="keyword">new</span> <span class="title class_">UserEntity</span>(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;21232F297A57A5A743894A0E4A801FC3&quot;</span>));  <span class="comment">// admin</span></span><br></pre></td></tr></table></figure>
<h4 id="使用盐值加密">使用盐值加密</h4>
<p>MD5 加密只是我们用来测试自定义加密的联系，MD5 虽然是不可逆的算法，但是加密后的值是一样的，有心人通过暴力破解还是可以成功的，这里我们就要使用 security 推荐的盐值加密，使用方法非常简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.userDetailsService((String username)-&gt;&#123;......&#125;)</span><br><span class="line">        <span class="comment">// 换一个实例给他就行了.....</span></span><br><span class="line">        .passwordEncoder(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取登录人信息">获取登录人信息</h3>
<h4 id="在控制器中获取">在控制器中获取</h4>
<p>我们在平时开发中都是讲登录信息存储到 session 中的，在控制器中通过 HttpSession 获取到当前用户的昵称、账号等其他信息，security 的话我们想要获取到信息需要在参数列表中添加以下参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">(Principal principal)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;登录人信息===&gt;&gt;&quot;</span> + principal);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*  打印后得到：</span></span><br><span class="line"><span class="comment">UsernamePasswordAuthenticationToken[Principal=org.springframework.security.core.userdetails.User [Username=zhang, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, credentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[用户列表:查询]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=92FCFF1A0CAF7E8E74C886874D73049A], Granted Authorities=[用户列表:查询]]  */</span></span><br></pre></td></tr></table></figure>
<p>可以看出，只有 username 和 password 以及角色权限信息，如果我们想要获得更多例如昵称、性别、生日以及注册信息等等都没有提供</p>
<p>仔细一看打印结果，发现用户信息都封装在了 <code>org.springframework.security.core.userdetails.User</code> 类中，这个类在练习【登录用户设置 → 连接数据库登录】时将用户信息以及角色权限封装的位置用过，这么说来我们获取的其实是这个类的信息，那么我们来修改一下之前的代码</p>
<blockquote>
<p>创建新的类继承 security 的 User 类</p>
</blockquote>
<p>在新的 <code>UserSecurityEntity</code> 类中声明一个 entity 属性，代表当前登录人的实体，并对外提供 get 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringSecurity封装用户登录信息的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSecurityEntity</span> <span class="keyword">extends</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserEntity entity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserSecurityEntity</span><span class="params">(</span></span><br><span class="line"><span class="params">          UserEntity entity,</span></span><br><span class="line"><span class="params">          Collection&lt;GrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(entity.getUsername(), entity.getPassword(), authorities);</span><br><span class="line">        entity.setPassword(<span class="string">&quot;******&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.entity = entity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserEntity <span class="title function_">getEntity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.entity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>修改之前的数据库登录代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.userDetailsService((String username)-&gt;&#123;  <span class="comment">// 省略一滩代码.......</span></span><br><span class="line">        <span class="comment">// 将 new User 更换为我们刚刚创建的类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserSecurityEntity</span>(userEntity, authorities);</span><br><span class="line">    &#125;).passwordEncoder(<span class="keyword">new</span> <span class="title class_">PwdEncoderConfig</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在回到控制器中在查看打印出来的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">登录人信息===&gt;&gt;UsernamePasswordAuthenticationToken [Principal=site.hanzhe.security.UserSecurityEntity [Username=zhang...</span><br></pre></td></tr></table></figure>
<p>可以看到，里面已经有我们刚刚创建好的那个类了，接下来我们来通过类型转换来获取到 entity 就万事大吉啦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toLevelX</span><span class="params">(Principal principal)</span>&#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">p</span> <span class="operator">=</span> ((UsernamePasswordAuthenticationToken) principal).getPrincipal();</span><br><span class="line">    <span class="type">UserEntity</span> <span class="variable">entity</span> <span class="operator">=</span> ((UserSecurityEntity) p).getEntity();</span><br><span class="line">    <span class="comment">// 获取成功！！！！！</span></span><br><span class="line">    System.out.println(entity);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="在页面上获取">在页面上获取</h4>
<p>在页面上使用 thymeleaf 除了场景启动器之外还需要添加另一个依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 版本号已在父工程中设置好了，不用我们手动设置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加好依赖后，还需要在对应使用 security 的页面中添加 <code>sec</code> 的引用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:sec</span>=<span class="string">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity5&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	sec推荐使用上面的URL，如果没有代码提示可以考虑换为：</span></span><br><span class="line"><span class="comment">	xmlns:sec=&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>
<p>在页面中获取到 entity 信息 ( 基于之前修改好的代码才可以这么获取 )：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.entity&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="记住我登录状态">记住我登录状态</h3>
<p>我们登录成功之后可以访问所有页面，根据正常流程来说当我重启浏览器后再次访问这个页面时，他会让我们你重新登录，现在我们要实现一劳永逸的方法，security 为我们提供了 <strong>记住我</strong> 功能，通过 <code>Cookie</code> 实现了重启浏览器也可以保持登录状态，而开启这个功能只需要一个方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">        ........</span><br><span class="line">        .rememberMe()  <span class="comment">// 开启&quot;记住我&quot;功能</span></span><br><span class="line">        .rememberMeParameter(<span class="string">&quot;remember&quot;</span>); <span class="comment">// 表单checkbox的name属性值，默认为remember-me</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注销登录状态"><em>注销登录状态</em></h3>
<p>之前我们通过移除 session 中的登录信息来实现退出登录，使用 security 后一直通过关闭浏览器的方式进行登录注销，在学习了 &quot; 记住我 &quot; 登录状态之后连关闭浏览器都可以保持登录状态了， 所以这里学习一下注销登录</p>
<p>注销登录的操作也非常简单，和登陆的表单设置差不多，只需要开启功能并指定控制器的 URL 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">        ......</span><br><span class="line">        .rememberMe()  <span class="comment">// 记住我</span></span><br><span class="line">         .rememberMeParameter(<span class="string">&quot;remember&quot;</span>)</span><br><span class="line">         .and()</span><br><span class="line">        .logout()      <span class="comment">// 开启注销功能</span></span><br><span class="line">            .logoutUrl(<span class="string">&quot;/doLogout&quot;</span>)  <span class="comment">// 指定注销需要请求的控制器地址，控制器代码不需要我们实现</span></span><br><span class="line">            .logoutSuccessUrl(<span class="string">&quot;/&quot;</span>);  <span class="comment">// 注销成功后跳转的目标页面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样 security 的配置就完成了，这里我选择将退出功能放到 level1/1 的页面中：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--主容器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:replace</span>=<span class="string">&quot;~&#123;index::nav-menu&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui segment&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Level-1-1<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/&#125;&quot;</span>&gt;</span>返回首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="symbol">&amp;nbsp;</span> <span class="symbol">&amp;nbsp;</span> <span class="symbol">&amp;nbsp;</span> <span class="symbol">&amp;nbsp;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/doLogout&#125;&quot;</span>&gt;</span>退出登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注销的控制器完成了，点击注销的超链接也完成了，接下来我们来测试一下结果：</p>
<p><img src="/img/security-05.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>结果点击退出登录之后提示 404 了，这是因为 <em>security 出于安全考虑配置了防止跨站请求伪造 ( CSRF )</em>，他要求我们的<strong>请求必须是 POST 请求，且需要携带参数 token 参数</strong>，之前的登录表单虽然我们没有添加 token 参数，但是仔细看请求信息的时候还是可以看出 scurity 自动为我们添加了这个参数：</p>
<p><img src="/img/security-06.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>我们的注销没有携带 token 参数并且不是 POST 请求，为了省事这里选择<em>关闭 CSRF 功能</em>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">        ......</span><br><span class="line">        .rememberMe()  <span class="comment">// 记住我</span></span><br><span class="line">         .rememberMeParameter(<span class="string">&quot;remember&quot;</span>)</span><br><span class="line">         .and()</span><br><span class="line">        .csrf().disable()  <span class="comment">// 关闭跨站请求伪造防护功能</span></span><br><span class="line">        .logout()      <span class="comment">// 开启注销功能</span></span><br><span class="line">            .logoutUrl(<span class="string">&quot;/doLogout&quot;</span>)  <span class="comment">// 指定注销需要请求的控制器地址，控制器代码不需要我们实现</span></span><br><span class="line">            .logoutSuccessUrl(<span class="string">&quot;/&quot;</span>);  <span class="comment">// 注销成功后跳转的目标页面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**扩展：**有一个和 <code>csrf().disable()</code> 长得非常像的一段代码需要注意一下：<code>.cors().disable()</code>，这个通常在前后端分离的情况使用，用于关闭跨域请求</p>
<h2 id="访问权限设置-二">访问权限设置(二)</h2>
<p>之前简单学习了一下访问权限设置，可以设置哪些页面可以直接访问、哪些页面需要登录后访问、还可以自定义登录页面、参数名称以及表单请求地址、登录的成功失败分别跳转的视图，接下来配合角色和权限实现权限控制</p>
<h3 id="Java代码控制授权">Java代码控制授权</h3>
<blockquote>
<p>通过权限控制访问权限</p>
</blockquote>
<p>首先调整一下测试数据，为他们分配合适的角色及权限：zhang 具有 vip 权限，admin 具有所有权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编辑假数据</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.userDetailsService((String username)-&gt;&#123;</span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> userService.selectUserByUsername(username);</span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// zhang只有vip1权限，admin具有所有权限</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="string">&quot;admin&quot;</span>.equals(username) )&#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;vip1&quot;</span>));</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;vip2&quot;</span>));</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;vip3&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;vip1&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserSecurityEntity</span>(userEntity, authorities);</span><br><span class="line">    &#125;).passwordEncoder(<span class="keyword">new</span> <span class="title class_">PwdEncoderConfig</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将请求资源设置权限，只有应有的权限才能访问对应的页面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改权限验证规则</span></span><br><span class="line">@<span class="title class_">Override</span></span><br><span class="line">protected <span class="keyword">void</span> <span class="title function_">configure</span>(<span class="title class_">HttpSecurity</span> http) throws <span class="title class_">Exception</span> &#123;</span><br><span class="line">    http.<span class="title function_">authorizeRequests</span>()</span><br><span class="line">            .<span class="title function_">antMatchers</span>(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>, <span class="string">&quot;/toLogin&quot;</span>,<span class="string">&quot;/views/login.html&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/doLogin&quot;</span>, <span class="string">&quot;/toPage/success&quot;</span>, <span class="string">&quot;/doLogout&quot;</span>)</span><br><span class="line">            .<span class="title function_">permitAll</span>()</span><br><span class="line">            <span class="comment">// laven1只有vip1及以上才可以访问</span></span><br><span class="line">            .<span class="title function_">antMatchers</span>(<span class="string">&quot;/level1/*&quot;</span>)</span><br><span class="line">            .<span class="title function_">hasAnyAuthority</span>(<span class="string">&quot;vip1&quot;</span>)</span><br><span class="line">            <span class="comment">// laven2只有vip2及以上才可以访问</span></span><br><span class="line">            .<span class="title function_">antMatchers</span>(<span class="string">&quot;/level2/*&quot;</span>)</span><br><span class="line">            .<span class="title function_">hasAnyAuthority</span>(<span class="string">&quot;vip2&quot;</span>)</span><br><span class="line">            <span class="comment">// lavel3只有vip3及以上才能访问，由于需要设置的权限太多这里通过角色来设置</span></span><br><span class="line">            .<span class="title function_">antMatchers</span>(<span class="string">&quot;/level3/*&quot;</span>)</span><br><span class="line">            .<span class="title function_">hasAnyAuthority</span>(<span class="string">&quot;vip3&quot;</span>)</span><br><span class="line">            <span class="comment">// 剩下的登录即可</span></span><br><span class="line">            .<span class="title function_">anyRequest</span>()</span><br><span class="line">            .<span class="title function_">authenticated</span>()</span><br><span class="line">        ........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>方法名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>hasAuthority</td>
<td>必须拥有目标权限才能访问</td>
</tr>
<tr>
<td>hasAnyAuthority</td>
<td>必须拥有目标权限 ( 可传多个参数 ) 才能访问</td>
</tr>
</tbody>
</table>
<blockquote>
<p>通过角色控制访问权限</p>
</blockquote>
<p>之前通过权限判断是否有访问资格，这次通过角色判断，代码实际上差不了多少：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改一下假数据</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.userDetailsService((String username)-&gt;&#123;</span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> userService.selectUserByUsername(username);</span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> ( <span class="string">&quot;admin&quot;</span>.equals(username) )&#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_普通会员&quot;</span>));</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_高级会员&quot;</span>));</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_超级会员&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_普通会员&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserSecurityEntity</span>(userEntity, authorities);</span><br><span class="line">    &#125;).passwordEncoder(<span class="keyword">new</span> <span class="title class_">PwdEncoderConfig</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改权限验证规则</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()  <span class="comment">// 根据请求请求进行验证</span></span><br><span class="line">        .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>, <span class="string">&quot;/toLogin&quot;</span>,<span class="string">&quot;/views/login.html&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/doLogin&quot;</span>, <span class="string">&quot;/toPage/success&quot;</span>, <span class="string">&quot;/doLogout&quot;</span>)</span><br><span class="line">        .permitAll()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/level1/*&quot;</span>)</span><br><span class="line">        .hasRole(<span class="string">&quot;普通会员&quot;</span>)</span><br><span class="line">        .antMatchers(<span class="string">&quot;/level2/*&quot;</span>)</span><br><span class="line">        .hasRole(<span class="string">&quot;高级会员&quot;</span>)</span><br><span class="line">        .antMatchers(<span class="string">&quot;/level3/*&quot;</span>)</span><br><span class="line">        .hasRole(<span class="string">&quot;超级会员&quot;</span>)</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>方法名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>hasRole</td>
<td>必须拥有目标角色才能访问</td>
</tr>
<tr>
<td>hasAnyRole</td>
<td>必须拥有目标角色 ( 可传多个参数 ) 才能访问</td>
</tr>
</tbody>
</table>
<blockquote>
<p>同时验证权限和角色</p>
</blockquote>
<p>可以通过权限验证，或者也可以通过角色验证，那么能不能两个混用呢？可以的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 再次修改测试数据</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改权限验证规则</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Spring%E5%AE%B6%E6%97%8F/" class="print-no-link">#Spring家族</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Spring Security</div>
      <div>http://example.com/2023/09/13/SpringSecurity笔记/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Shi_Kang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>September 13, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/05/02/Spring%20Data%20Jpa%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/" title="Spring Data Jpa 学习笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Spring Data Jpa 学习笔记</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/02/21/Docker%E7%AC%94%E8%AE%B0/" title="Docker使用详解">
                        <span class="hidden-mobile">Docker使用详解</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'gusheng2000/gusheng2000.github.io');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'Comment');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>skr</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
